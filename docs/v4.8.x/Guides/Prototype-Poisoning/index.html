<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-v4.8.x plugin-docs plugin-id-default docs-doc-id-Guides/Prototype-Poisoning">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Prototype-Poisoning | Fastify</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://fastify.io/website-next/img/logos/fastify-black.png"><meta data-rh="true" name="twitter:image" content="https://fastify.io/website-next/img/logos/fastify-black.png"><meta data-rh="true" property="og:url" content="https://fastify.io/website-next/docs/v4.8.x/Guides/Prototype-Poisoning"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v4.8.x"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v4.8.x"><meta data-rh="true" name="docsearch:version" content="v4.8.x"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v4.8.x"><meta data-rh="true" property="og:title" content="Prototype-Poisoning | Fastify"><meta data-rh="true" name="description" content="The following is an article written by Eran Hammer."><meta data-rh="true" property="og:description" content="The following is an article written by Eran Hammer."><link data-rh="true" rel="icon" href="/website-next/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fastify.io/website-next/docs/v4.8.x/Guides/Prototype-Poisoning"><link data-rh="true" rel="alternate" href="https://fastify.io/website-next/docs/v4.8.x/Guides/Prototype-Poisoning" hreflang="en"><link data-rh="true" rel="alternate" href="https://fastify.io/website-next/docs/v4.8.x/Guides/Prototype-Poisoning" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://DMPMC33PLU-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Fastify" href="/website-next/opensearch.xml"><link rel="stylesheet" href="/website-next/assets/css/styles.39d23afd.css">
<link rel="preload" href="/website-next/assets/js/runtime~main.ba70f906.js" as="script">
<link rel="preload" href="/website-next/assets/js/main.34c57a82.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/website-next/"><div class="navbar__logo"><img src="/website-next/img/logos/fastify-black.png" alt="Fastify Cheetah Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/website-next/img/logos/fastify-white.png" alt="Fastify Cheetah Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/website-next/docs/v4.8.x/">Docs</a><a class="navbar__item navbar__link" href="/website-next/ecosystem">Ecosystem</a><a class="navbar__item navbar__link" href="/website-next/benchmarks">Benchmarks</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/website-next/docs/v4.8.x/">v4.8.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/website-next/docs/latest/Guides/Prototype-Poisoning">latest (v4.11.x)</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.11.x/Guides/Prototype-Poisoning">v4.11.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.10.x/Guides/Prototype-Poisoning">v4.10.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.9.x/Guides/Prototype-Poisoning">v4.9.x</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/website-next/docs/v4.8.x/Guides/Prototype-Poisoning">v4.8.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.7.x/Guides/Prototype-Poisoning">v4.7.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.6.x/Guides/Prototype-Poisoning">v4.6.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.5.x/Guides/Prototype-Poisoning">v4.5.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.4.x/Guides/Prototype-Poisoning">v4.4.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.3.x/Guides/Prototype-Poisoning">v4.3.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.2.x/Guides/Prototype-Poisoning">v4.2.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.1.x/Guides/Prototype-Poisoning">v4.1.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v4.0.x/Guides/Prototype-Poisoning">v4.0.x</a></li><li><a class="dropdown__link" href="/website-next/docs/v3.29.x/Guides/Prototype-Poisoning">v3.29.x</a></li></ul></div><a href="https://github.com/fastify/website-next" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/website-next/docs/v4.8.x/Guides/">Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Benchmarking">Benchmarking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Contributing">Contributing To Fastify</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Database">Database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Delay-Accepting-Requests">Delay Accepting Requests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Ecosystem">Ecosystem</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Fluent-Schema">Fluent-Schema</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Getting-Started">Getting-Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Migration-Guide-V3">V3 Migration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Migration-Guide-V4">V4 Migration Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Plugins-Guide">The hitchhiker&#x27;s guide to plugins</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Prototype-Poisoning">Prototype-Poisoning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Recommendations">Recommendations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Serverless">Serverless</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Style-Guide">Fastify Style Guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website-next/docs/v4.8.x/Guides/Write-Plugin">How to write a good plugin</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/website-next/docs/v4.8.x/Reference/">Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Fastify<!-- --> <b>v4.8.x</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/website-next/docs/latest/Guides/Prototype-Poisoning">latest version</a></b> (<!-- -->latest (v4.11.x)<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/website-next/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/website-next/docs/v4.8.x/Guides/"><span itemprop="name">Guides</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Prototype-Poisoning</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v4.8.x</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Prototype-Poisoning</h1></header><blockquote><p>The following is an article written by Eran Hammer.
It is reproduced here for posterity <a href="https://github.com/fastify/fastify/issues/1426#issuecomment-817957913" target="_blank" rel="noopener noreferrer">with permission</a>.
It has been reformatted from the original HTML source to Markdown source,
but otherwise remains the same. The original HTML can be retrieved from the
above permission link.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-tale-of-prototype-poisoning">A Tale of (prototype) Poisoning<a class="hash-link" href="#a-tale-of-prototype-poisoning" title="Direct link to heading">​</a></h2><a id="pp"></a><p>This story is a behind-the-scenes look at the process and drama created by a
particularity interesting web security issue. It is also a perfect illustration
of the efforts required to maintain popular pieces of open source software and
the limitations of existing communication channels.</p><p>But first, if you use a JavaScript framework to process incoming JSON data, take
a moment to read up on <a href="https://medium.com/intrinsic/javascript-prototype-poisoning-vulnerabilities-in-the-wild-7bc15347c96" target="_blank" rel="noopener noreferrer">Prototype
Poisoning</a>
in general, and the specific <a href="https://github.com/hapijs/hapi/issues/3916" target="_blank" rel="noopener noreferrer">technical
details</a> of this issue. I&#x27;ll explain
it all in a bit, but since this could be a critical issue, you might want to
verify your own code first. While this story is focused on a specific framework,
any solution that uses <code>JSON.parse()</code> to process external data is potentially at
risk.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="boom">BOOM<a class="hash-link" href="#boom" title="Direct link to heading">​</a></h3><a id="pp-boom"></a><p>Our story begins with a bang.</p><p>The engineering team at Lob (long time generous supporters of my work!) reported
a critical security vulnerability they identified in our data validation
module — <a href="https://github.com/hapijs/joi" target="_blank" rel="noopener noreferrer">joi</a>. They provided some technical
details and a proposed solution.</p><p>The main purpose of a data validation library is to ensure the output fully
complies with the rules defined. If it doesn&#x27;t, validation fails. If it passes,
your can blindly trust that the data you are working with is safe. In fact, most
developers treat validated input as completely safe from a system integrity
perspective. This is crucial.</p><p>In our case, the Lob team provided an example where some data was able to sneak
by the validation logic and pass through undetected. This is the worst possible
defect a validation library can have.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prototype-in-anutshell">Prototype in a nutshell<a class="hash-link" href="#prototype-in-anutshell" title="Direct link to heading">​</a></h3><a id="pp-nutshell"></a><p>To understand this story, you need to understand how JavaScript works a bit.
Every object in JavaScript can have a prototype. It is a set of methods and
properties it &quot;inherits&quot; from another object. I put inherits in quotes because
JavaScript isn&#x27;t really an object oriented language.</p><p>A long time ago, for a bunch of irrelevant reasons, someone decided that it
would be a good idea to use the special property name <code>__proto__</code> to access (and
set) an object&#x27;s prototype. This has since been deprecated but nevertheless,
fully supported.</p><p>To demonstrate:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; const a = { b: 5 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; a.b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; a.__proto__ = { c: 6 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; a.c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ b: 5 }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see, the object doesn&#x27;t have a <code>c</code> property, but its prototype does.
When validating the object, the validation library ignores the prototype and
only validates the object&#x27;s own properties. This allows <code>c</code> to sneak in via the
prototype.</p><p>Another important part of this story is the way <code>JSON.parse()</code> — a utility
provided by the language to convert JSON formatted text into objects  —  handles
this magic <code>__proto__</code> property name.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; const text = &#x27;{ &quot;b&quot;: 5, &quot;__proto__&quot;: { &quot;c&quot;: 6 } }&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; const a = JSON.parse(text);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ b: 5, __proto__: { c: 6 } }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Notice how <code>a</code> has a <code>__proto__</code> property. This is not a prototype reference. It
is a simple object property key, just like <code>b</code>. As we&#x27;ve seen from the first
example, we can&#x27;t actually create this key through assignment as that invokes
the prototype magic and sets an actual prototype. <code>JSON.parse()</code> however, sets a
simple property with that poisonous name.</p><p>By itself, the object created by <code>JSON.parse()</code> is perfectly safe. It doesn&#x27;t
have a prototype of its own. It has a seemingly harmless property that just
happens to overlap with a built-in JavaScript magic name.</p><p>However, other methods are not as lucky:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; const x = Object.assign({}, a);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{ b: 5}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; x.c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If we take the <code>a</code> object created earlier by <code>JSON.parse()</code> and pass it to the
helpful <code>Object.assign()</code> method (used to perform a shallow copy of all the top
level properties of <code>a</code> into the provided empty <code>{}</code> object), the magic
<code>__proto__</code> property &quot;leaks&quot; and becomes <code>x</code> &#x27;s actual prototype.</p><p>Surprise!</p><p>Put together, if you get some external text input, parse it with <code>JSON.parse()</code>
then perform some simple manipulation of that object (say, shallow clone and add
an <code>id</code> ), and then pass it to our validation library, anything passed through
via <code>__proto__</code> would sneak in undetected.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="oh-joi">Oh joi!<a class="hash-link" href="#oh-joi" title="Direct link to heading">​</a></h3><a id="pp-oh-joi"></a><p>The first question is, of course, why does the validation module <strong>joi</strong> ignore
the prototype and let potentially harmful data through? We asked ourselves the
same question and our instant thought was &quot;it was an oversight&quot;. A bug. A really
big mistake. The joi module should not have allowed this to happen. But…</p><p>While joi is used primarily for validating web input data, it also has a
significant user base using it to validate internal objects, some of which have
prototypes. The fact that joi ignores the prototype is a helpful &quot;feature&quot;. It
allows validating the object&#x27;s own properties while ignoring what could be a
very complicated prototype structure (with many methods and literal properties).</p><p>Any solution at the joi level would mean breaking some currently working code.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-rightthing">The right thing<a class="hash-link" href="#the-rightthing" title="Direct link to heading">​</a></h3><a id="pp-right-thing"></a><p>At this point, we were looking at a devastatingly bad security vulnerability.
Right up there in the upper echelons of epic security failures. All we knew is
that our extremely popular data validation library fails to block harmful data,
and that this data is trivial to sneak through. All you need to do is add
<code>__proto__</code> and some crap to a JSON input and send it on its way to an
application built using our tools.</p><p>(Dramatic pause)</p><p>We knew we had to fix joi to prevent this but given the scale of this issue, we
had to do it in a way that will put a fix out without drawing too much attention
to it — without making it too easy to exploit — at least for a few days until
most systems received the update.</p><p>Sneaking a fix isn&#x27;t the hardest thing to accomplish. If you combine it with an
otherwise purposeless refactor of the code, and throw in a few unrelated bug
fixes and maybe a cool new feature, you can publish a new version without
drawing attention to the real issue being fixed.</p><p>The problem was, the right fix was going to break valid use cases. You see, joi
has no way of knowing if you want it to ignore the prototype you set, or block
the prototype set by an attacker. A solution that fixes the exploit will break
code and breaking code tends to get a lot of attention.</p><p>On the other hand, if we released a proper (<a href="https://semver.org/" target="_blank" rel="noopener noreferrer">semantically
versioned</a>) fix, mark it as a breaking change, and add a
new API to explicitly tell joi what you want it to do with the prototype, we
will share with the world how to exploit this vulnerability while also making it
more time consuming for systems to upgrade (breaking changes never get applied
automatically by build tools).</p><p>Lose — Lose.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-detour">A detour<a class="hash-link" href="#a-detour" title="Direct link to heading">​</a></h3><a id="pp-detour"></a><p>While the issue at hand was about incoming request payloads, we had to pause and
check if it could also impact data coming via the query string, cookies, and
headers. Basically, anything that gets serialized into objects from text.</p><p>We quickly confirmed node default query string parser was fine as well as its
header parser. I identified one potential issue with base64-encoded JSON cookies
as well as the usage of custom query string parsers. We also wrote some tests to
confirm that the most popular third-party query string parser  —
<a href="https://www.npmjs.com/package/qs" target="_blank" rel="noopener noreferrer">qs</a> —  was not vulnerable (it is not!).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-development">A development<a class="hash-link" href="#a-development" title="Direct link to heading">​</a></h3><a id="pp-a-development"></a><p>Throughout this triage, we just assumed that the offending input with its
poisoned prototype was coming into joi from hapi, the web framework connecting
the hapi.js ecosystem. Further investigation by the Lob team found that the
problem was a bit more nuanced.</p><p>hapi used <code>JSON.parse()</code> to process incoming data. It first set the result
object as a <code>payload</code> property of the incoming request, and then passed that
same object for validation by joi before being passed to the application
business logic for processing. Since <code>JSON.parse()</code> doesn&#x27;t actually leak the
<code>__proto__</code> property, it would arrive to joi with an invalid key and fail
validation.</p><p>However, hapi provides two extension points where the payload data can be
inspected (and processed) prior to validation. It is all properly documented and
well understood by most developers. The extension points are there to allow you
to interact with the raw inputs prior to validation for legitimate (and often
security related) reasons.</p><p>If during one of these two extension points, a developer used <code>Object.assign()</code>
or a similar method on the payload, the <code>__proto__</code> property would leak and
become an actual prototype.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sigh-ofrelief">Sigh of relief<a class="hash-link" href="#sigh-ofrelief" title="Direct link to heading">​</a></h3><a id="pp-sigh-of-relief"></a><p>We were now dealing with a much different level of awfulness. Manipulating the
payload object prior to validation is not common which meant this was no longer
a doomsday scenario. It was still potentially catastrophic but the exposure
dropped from every joi user to some very specific implementations.</p><p>We were no longer looking at a secretive joi release. The issue in joi is still
there, but we can now address it properly with a new API and breaking release
over the next few weeks.</p><p>We also knew that we can easily mitigate this vulnerability at the framework
level since it knows which data is coming from the outside and which is
internally generated. The framework is really the only piece that can protect
developers against making such unexpected mistakes.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="good-news-bad-news-nonews">Good news, bad news, no news?<a class="hash-link" href="#good-news-bad-news-nonews" title="Direct link to heading">​</a></h3><a id="pp-good-news-no-news"></a><p>The good news was that this wasn&#x27;t our fault. It wasn&#x27;t a bug in hapi or joi. It
was only possible through a complex combination of actions that was not unique
to hapi or joi. This can happen with every other JavaScript framework. If hapi
is broken, then the world is broken.</p><p>Great — we solved the blame game.</p><p>The bad news is that when there is nothing to blame (other than JavaScript
itself), it is much harder getting it fixed.</p><p>The first question people ask once a security issue is found is if there is
going to be a CVE published. A CVE — Common Vulnerabilities and Exposures — is a
<a href="https://cve.mitre.org/" target="_blank" rel="noopener noreferrer">database</a> of known security issues. It is a critical
component of web security. The benefit of publishing a CVE is that it
immediately triggers alarms and informs and often breaks automated builds until
the issue is resolved.</p><p>But what do we pin this to?</p><p>Probably, nothing. We are still debating whether we should tag some versions of
hapi with a warning. The &quot;we&quot; is the node security process. Since we now have a
new version of hapi that mitigate the problem by default, it can be considered a
fix. But because the fix isn&#x27;t to a problem in hapi itself, it is not exactly
kosher to declare older versions harmful.</p><p>Publishing an advisory on previous versions of hapi for the sole purpose of
nudging people into awareness and upgrade is an abuse of the advisory process.
I&#x27;m personally fine with abusing it for the purpose of improving security but
that&#x27;s not my call. As of this writing, it is still being debated.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-solutionbusiness">The solution business<a class="hash-link" href="#the-solutionbusiness" title="Direct link to heading">​</a></h3><a id="pp-solution-business"></a><p>Mitigating the issue wasn&#x27;t hard. Making it scale and safe was a bit more
involved. Since we knew where harmful data can enter the system, and we knew
where we used the problematic <code>JSON.parse()</code> we could replace it with a safe
implementation.</p><p>One problem. Validating data can be costly and we are now planning on validating
every incoming JSON text. The built-in <code>JSON.parse()</code> implementation is fast.
Really really fast. It is unlikely we can build a replacement that will be more
secure and anywhere as fast. Especially not overnight and without introducing
new bugs.</p><p>It was obvious we were going to wrap the existing <code>JSON.parse()</code> method with
some additional logic. We just had to make sure it was not adding too much
overhead. This isn&#x27;t just a performance consideration but also a security one.
If we make it easy to slow down a system by simply sending specific data, we
make it easy to execute a <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack" target="_blank" rel="noopener noreferrer">DoS
attack</a> at very low
cost.</p><p>I came up with a stupidly simple solution: first parse the text using the
existing tools. If this didn&#x27;t fail, scan the original raw text for the
offending string &quot;<strong>proto</strong>&quot;. Only if we find it, perform an actual scan of the
object. We can&#x27;t block every reference to &quot;<strong>proto</strong>&quot; — sometimes it is
perfectly valid value (like when writing about it here and sending this text
over to Medium for publication).</p><p>This made the &quot;happy path&quot; practically as fast as before. It just added one
function call, a quick text scan (again, very fast built-in implementation), and
a conditional return. The solution had negligible impact on the vast majority of
data expected to pass through it.</p><p>Next problem. The prototype property doesn&#x27;t have to be at the top level of the
incoming object. It can be nested deep inside. This means we cannot just check
for the presence of it at the top level. We need to recursively iterate through
the object.</p><p>While recursive functions are a favorite tool, they could be disastrous when
writing security-conscious code. You see, recursive function increase the size
of the runtime call stack. The more times you loop, the longer the call stack
gets. At some point — KABOOM— you reach the maximum length and the process dies.</p><p>If you cannot guarantee the shape of the incoming data, recursive iteration
becomes an open threat. An attacker only needs to craft a deep enough object to
crash your servers.</p><p>I used a flat loop implementation that is both more memory efficient (less
function calls, less passing of temporary arguments) and more secure. I am not
pointing this out to brag, but to highlight how basic engineering practices can
create (or avoid) security pitfalls.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-to-thetest">Putting it to the test<a class="hash-link" href="#putting-it-to-thetest" title="Direct link to heading">​</a></h3><a id="pp-putting-to-test"></a><p>I sent the code to two people. First to <a href="https://github.com/nlf" target="_blank" rel="noopener noreferrer">Nathan
LaFreniere</a> to double check the security properties of
the solution, and then to <a href="https://github.com/mcollina" target="_blank" rel="noopener noreferrer">Matteo Collina</a> to
review the performance. They are among the very best at what they do and often
my go-to people.</p><p>The performance benchmarks confirmed that the &quot;happy path&quot; was practically
unaffected. The interesting findings was that removing the offending values was
faster then throwing an exception. This raised the question of what should be
the default behavior of the new module — which I called
<a href="https://github.com/hapijs/bourne" target="_blank" rel="noopener noreferrer"><strong>bourne</strong></a> —  error or sanitize.</p><p>The concern, again, was exposing the application to a DoS attack. If sending a
request with <code>__proto__</code> makes things 500% slower, that could be an easy vector
to exploit. But after a bit more testing we confirmed that sending <strong>any</strong>
invalid JSON text was creating a very similar cost.</p><p>In other words, if you parse JSON, invalid values are going to cost you more,
regardless of what makes them invalid. It is also important to remember that
while the benchmark showed the significant % cost of scanning suspected objects,
the actual cost in CPU time was still in the fraction of milliseconds. Important
to note and measure but not actually harmful.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hapi-ever-after">hapi ever-after<a class="hash-link" href="#hapi-ever-after" title="Direct link to heading">​</a></h3><a id="pp-hapi-ever-after"></a><p>There are a bunch of things to be grateful for.</p><p>The initial disclosure by the Lob team was perfect. It was reported privately,
to the right people, with the right information. They followed up with
additional findings, and gave us the time and space to resolve it the right way.
Lob also was a major sponsor of my work on hapi over the years and that
financial support is critical to allow everything else to happen. More on that
in a bit.</p><p>Triage was stressful but staffed with the right people. Having folks like
<a href="https://github.com/Marsup" target="_blank" rel="noopener noreferrer">Nicolas Morel</a>, Nathan, and Matteo, available and
eager to help is critical. This isn&#x27;t easy to deal with without the pressure,
but with it, mistakes are likely without proper team collaboration.</p><p>We got lucky with the actual vulnerability. What started up looking like a
catastrophic problem, ended up being a delicate but straight-forward problem to
address.</p><p>We also got lucky by having full access to mitigate it at the source — didn&#x27;t
need to send emails to some unknown framework maintainer and hope for a quick
answer. hapi&#x27;s total control over all of its dependencies proved its usefulness
and security again. Not using <a href="https://hapi.dev" target="_blank" rel="noopener noreferrer">hapi</a>? <a href="https://hueniverse.com/why-you-should-consider-hapi-6163689bd7c2" target="_blank" rel="noopener noreferrer">Maybe you
should</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-after-in-happy-ever-after">The after in happy ever-after<a class="hash-link" href="#the-after-in-happy-ever-after" title="Direct link to heading">​</a></h3><a id="pp-after-ever-after"></a><p>This is where I have to take advantage of this incident to reiterate the cost
and need for sustainable and secure open source.</p><p>My time alone on this one issue exceeded 20 hours. That&#x27;s half a working week.
It came at the end of a month were I already spent over 30 hours publishing a
new major release of hapi (most of the work was done in December). This puts me
at a personal financial loss of over $5000 this month (I had to cut back on paid
client work to make time for it).</p><p>If you rely on code I maintain, this is exactly the level of support, quality,
and commitment you want (and lets be honest — expect). Most of you take it for
granted — not just my work but the work of hundreds of other dedicated open
source maintainers.</p><p>Because this work is important, I decided to try and make it not just
financially sustainable but to grow and expand it. There is so much to improve.
This is exactly what motivates me to implement the new <a href="https://web.archive.org/web/20190201220503/https://hueniverse.com/on-hapi-licensing-a-preview-f982662ee898" target="_blank" rel="noopener noreferrer">commercial licensing
plan</a>
coming in March. You can read more about it
<a href="https://web.archive.org/web/20190201220503/https://hueniverse.com/on-hapi-licensing-a-preview-f982662ee898" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Of all the time consuming things, security is at the very top. I hope this story
successfully conveyed not just the technical details, but also the human drama and
what it takes to keep the web secure.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/fastify/fastify/edit/main/docs/Guides/Prototype-Poisoning.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/website-next/docs/v4.8.x/Guides/Plugins-Guide"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">The hitchhiker&#x27;s guide to plugins</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/website-next/docs/v4.8.x/Guides/Recommendations"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Recommendations</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#a-tale-of-prototype-poisoning" class="table-of-contents__link toc-highlight">A Tale of (prototype) Poisoning</a><ul><li><a href="#boom" class="table-of-contents__link toc-highlight">BOOM</a></li><li><a href="#prototype-in-anutshell" class="table-of-contents__link toc-highlight">Prototype in a nutshell</a></li><li><a href="#oh-joi" class="table-of-contents__link toc-highlight">Oh joi!</a></li><li><a href="#the-rightthing" class="table-of-contents__link toc-highlight">The right thing</a></li><li><a href="#a-detour" class="table-of-contents__link toc-highlight">A detour</a></li><li><a href="#a-development" class="table-of-contents__link toc-highlight">A development</a></li><li><a href="#sigh-ofrelief" class="table-of-contents__link toc-highlight">Sigh of relief</a></li><li><a href="#good-news-bad-news-nonews" class="table-of-contents__link toc-highlight">Good news, bad news, no news?</a></li><li><a href="#the-solutionbusiness" class="table-of-contents__link toc-highlight">The solution business</a></li><li><a href="#putting-it-to-thetest" class="table-of-contents__link toc-highlight">Putting it to the test</a></li><li><a href="#hapi-ever-after" class="table-of-contents__link toc-highlight">hapi ever-after</a></li><li><a href="#the-after-in-happy-ever-after" class="table-of-contents__link toc-highlight">The after in happy ever-after</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/website-next/docs/latest/Guides/Getting-Started">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/fastify" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/fastify" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/fastifyjs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/fastify/website-next" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/website-next/assets/js/runtime~main.ba70f906.js"></script>
<script src="/website-next/assets/js/main.34c57a82.js"></script>
</body>
</html>