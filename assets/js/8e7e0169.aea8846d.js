"use strict";(self.webpackChunk_fastify_website=self.webpackChunk_fastify_website||[]).push([[2232],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),p=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(t),m=r,f=c["".concat(l,".").concat(m)]||c[m]||u[m]||o;return t?a.createElement(f,i(i({ref:n},d),{},{components:t})):a.createElement(f,i({ref:n},d))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=c;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},50929:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=t(87462),r=(t(67294),t(3905));const o={},i=void 0,s={unversionedId:"Documentation/Serverless",id:"version-v2.15.x/Documentation/Serverless",title:"Serverless",description:"Run serverless applications and REST APIs using your existing Fastify application.",source:"@site/versioned_docs/version-v2.15.x/Documentation/Serverless.md",sourceDirName:"Documentation",slug:"/Documentation/Serverless",permalink:"/website-next/docs/v2.15.x/Documentation/Serverless",draft:!1,tags:[],version:"v2.15.x",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Server",permalink:"/website-next/docs/v2.15.x/Documentation/Server"},next:{title:"Testing",permalink:"/website-next/docs/v2.15.x/Documentation/Testing"}},l={},p=[{value:"Contents",id:"contents",level:3},{value:"Attention Readers:",id:"attention-readers",level:3},{value:"AWS Lambda",id:"aws-lambda",level:2},{value:"app.js",id:"appjs",level:3},{value:"lambda.js",id:"lambdajs",level:3},{value:"Example",id:"example",level:3},{value:"Considerations",id:"considerations",level:3},{value:"Google Cloud Run",id:"google-cloud-run",level:2},{value:"Adjust Fastify server",id:"adjust-fastify-server",level:3},{value:"Add a Dockerfile",id:"add-a-dockerfile",level:3},{value:"Add a .dockerignore",id:"add-a-dockerignore",level:3},{value:"Submit build",id:"submit-build",level:3},{value:"Deploy Image",id:"deploy-image",level:3},{value:"Zeit Now",id:"zeit-now",level:2}],d={toc:p};function u(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Run serverless applications and REST APIs using your existing Fastify application."),(0,r.kt)("h3",{id:"contents"},"Contents"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#aws-lambda"},"AWS Lambda")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#google-cloud-run"},"Google Cloud Run")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#zeit-now"},"Zeit Now"))),(0,r.kt)("h3",{id:"attention-readers"},"Attention Readers:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Fastify is not designed to run on serverless environments.\nThe Fastify framework is designed to make implementing a traditional HTTP/S server easy.\nServerless environments requests differently than a standard HTTP/S server;\nthus, we cannot guarantee it will work as expected with Fastify.\nRegardless, based on the examples given in this document,\nit is possible to use Fastify in a serverless environment.\nAgain, keep in mind that this is not Fastify's intended use case and\nwe do not test for such integration scenarios.")),(0,r.kt)("h2",{id:"aws-lambda"},"AWS Lambda"),(0,r.kt)("p",null,"The sample provided allows you to easily build serverless web applications/services\nand RESTful APIs using Fastify on top of AWS Lambda and Amazon API Gateway."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note: Using ",(0,r.kt)("a",{parentName:"em",href:"https://github.com/fastify/aws-lambda-fastify"},"aws-lambda-fastify")," is just one possible way.")),(0,r.kt)("h3",{id:"appjs"},"app.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify');\n\nfunction init() {\n  const app = fastify();\n  app.get('/', (request, reply) => reply.send({ hello: 'world' }));\n  return app;\n}\n\nif (require.main === module) {\n  // called directly i.e. \"node app\"\n  init().listen(3000, (err) => {\n    if (err) console.error(err);\n    console.log('server listening on 3000');\n  });\n} else {\n  // required as a module => executed on aws lambda\n  module.exports = init;\n}\n\n")),(0,r.kt)("p",null,"When executed in your lambda function we don't need to listen to a specific port,\nso we just export the wrapper function ",(0,r.kt)("inlineCode",{parentName:"p"},"init")," in this case.\nThe ",(0,r.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Serverless/#lambda-js"},(0,r.kt)("inlineCode",{parentName:"a"},"lambda.js"))," file will use this export."),(0,r.kt)("p",null,"When you execute your Fastify application like always,\ni.e. ",(0,r.kt)("inlineCode",{parentName:"p"},"node app.js")," ",(0,r.kt)("em",{parentName:"p"},"(the detection for this could be ",(0,r.kt)("inlineCode",{parentName:"em"},"require.main === module"),")"),",\nyou can normally listen to your port, so you can still run your Fastify function locally."),(0,r.kt)("h3",{id:"lambdajs"},"lambda.js"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const awsLambdaFastify = require('aws-lambda-fastify')\nconst init = require('./app');\n\nconst proxy = awsLambdaFastify(init())\n// or\n// const proxy = awsLambdaFastify(init(), { binaryMimeTypes: ['application/octet-stream'] })\n\nexports.handler = proxy;\n// or\n// exports.handler = (event, context, callback) => proxy(event, context, callback);\n// or\n// exports.handler = (event, context) => proxy(event, context);\n// or\n// exports.handler = async (event, context) => proxy(event, context);\n\n")),(0,r.kt)("p",null,"We just require ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/aws-lambda-fastify"},"aws-lambda-fastify"),"\n(make sure you install the dependency ",(0,r.kt)("inlineCode",{parentName:"p"},"npm i --save aws-lambda-fastify"),") and our\n",(0,r.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Serverless/#app-js"},(0,r.kt)("inlineCode",{parentName:"a"},"app.js"))," file and call the\nexported ",(0,r.kt)("inlineCode",{parentName:"p"},"awsLambdaFastify")," function with the ",(0,r.kt)("inlineCode",{parentName:"p"},"app")," as the only parameter.\nThe resulting ",(0,r.kt)("inlineCode",{parentName:"p"},"proxy")," function has the correct signature to be used as lambda ",(0,r.kt)("inlineCode",{parentName:"p"},"handler")," function.\nThis way all the incoming events (API Gateway requests) are passed to the ",(0,r.kt)("inlineCode",{parentName:"p"},"proxy")," function of ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/aws-lambda-fastify"},"aws-lambda-fastify"),"."),(0,r.kt)("h3",{id:"example"},"Example"),(0,r.kt)("p",null,"An example deployable with ",(0,r.kt)("a",{parentName:"p",href:"https://claudiajs.com/tutorials/serverless-express.html"},"claudia.js")," can be found ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/claudiajs/example-projects/tree/master/fastify-app-lambda"},"here"),"."),(0,r.kt)("h3",{id:"considerations"},"Considerations"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"API Gateway doesn't support streams yet, so you're not able to handle ",(0,r.kt)("a",{parentName:"li",href:"https://www.fastify.io/docs/latest/Reply/#streams"},"streams"),". "),(0,r.kt)("li",{parentName:"ul"},"API Gateway has a timeout of 29 seconds, so it's important to provide a reply during this time.")),(0,r.kt)("h2",{id:"google-cloud-run"},"Google Cloud Run"),(0,r.kt)("p",null,"Unlike AWS Lambda or Google Cloud Functions, Google Cloud Run is a serverless ",(0,r.kt)("strong",{parentName:"p"},"container")," environment. It's primary purpose is to provide an infrastructure-abstracted environment to run arbitrary containers. As a result, Fastify can be deployed to Google Cloud Run with little-to-no code changes from the way you would write your Fastify app normally."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Follow the steps below to deploy to Google Cloud Run if you are already familiar with gcloud or just follow their ",(0,r.kt)("a",{parentName:"em",href:"https://cloud.google.com/run/docs/quickstarts/build-and-deploy"},"quickstart")),"."),(0,r.kt)("h3",{id:"adjust-fastify-server"},"Adjust Fastify server"),(0,r.kt)("p",null,"In order for Fastify to properly listen for requests within the container, be sure to set the correct port and address:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'function build() {\n  const fastify = Fastify({ trustProxy: true })\n  return fastify\n}\n\nasync function start() {\n  // Google Cloud Run will set this environment variable for you, so\n  // you can also use it to detect if you are running in Cloud Run\n  const IS_GOOGLE_CLOUD_RUN = process.env.K_SERVICE !== undefined\n\n  // You must listen on the port Cloud Run provides\n  const port = process.env.PORT || 3000\n\n  // You must listen on all IPV4 addresses in Cloud Run\n  const address = IS_GOOGLE_CLOUD_RUN ? "0.0.0.0" : undefined\n\n  try {\n    const server = build()\n    const address = await server.listen(port, address)\n    console.log(`Listening on ${address}`)\n  } catch (err) {\n    console.error(err)\n    process.exit(1)\n  }\n}\n\nmodule.exports = build\n\nif (require.main === module) {\n  start()\n}\n\n')),(0,r.kt)("h3",{id:"add-a-dockerfile"},"Add a Dockerfile"),(0,r.kt)("p",null,"You can add any valid ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," that packages and runs a Node app. A basic ",(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")," can be found in the official ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/knative/docs/blob/2d654d1fd6311750cc57187a86253c52f273d924/docs/serving/samples/hello-world/helloworld-nodejs/Dockerfile"},"gcloud docs"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'\n# Use the official Node.js 10 image.\n\n# https://hub.docker.com/_/node\nFROM node:10\n\n\n# Create and change to the app directory.\nWORKDIR /usr/src/app\n\n\n# Copy application dependency manifests to the container image.\n\n# A wildcard is used to ensure both package.json AND package-lock.json are copied.\n\n# Copying this separately prevents re-running npm install on every code change.\nCOPY package*.json ./\n\n\n# Install production dependencies.\nRUN npm install --only=production\n\n\n# Copy local code to the container image.\nCOPY . .\n\n\n# Run the web service on container startup.\nCMD [ "npm", "start" ]\n\n')),(0,r.kt)("h3",{id:"add-a-dockerignore"},"Add a .dockerignore"),(0,r.kt)("p",null,"To keep build artifacts out of your container (which keeps it small and improves build times), add a ",(0,r.kt)("inlineCode",{parentName:"p"},".dockerignore")," file like the one below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-.dockerignore"},"Dockerfile\nREADME.md\nnode_modules\nnpm-debug.log\n\n")),(0,r.kt)("h3",{id:"submit-build"},"Submit build"),(0,r.kt)("p",null,"Next, submit your app to be built into a Docker image by running the following command (replacing ",(0,r.kt)("inlineCode",{parentName:"p"},"PROJECT-ID")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"APP-NAME")," with your GCP project id and an app name):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"gcloud builds submit --tag gcr.io/PROJECT-ID/APP-NAME\n\n")),(0,r.kt)("h3",{id:"deploy-image"},"Deploy Image"),(0,r.kt)("p",null,"After your image has built, you can deploy it with the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"gcloud beta run deploy --image gcr.io/PROJECT-ID/APP-NAME --platform managed\n\n")),(0,r.kt)("p",null,"Your app will be accessible from the URL GCP provides."),(0,r.kt)("h2",{id:"zeit-now"},"Zeit Now"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://zeit.co/home"},"now")," provides zero configuration deployment for\nNode.js applications. In order to use now, it is as simple as\nconfiguring your ",(0,r.kt)("inlineCode",{parentName:"p"},"now.json")," file like the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "version": 2,\n  "builds": [\n    {\n      "src": "api/serverless.js",\n      "use": "@now/node",\n      "config": {\n        "helpers": false\n      }\n    }\n  ],\n  "routes": [\n    { "src": "/.*", "dest": "/api/serverless.js"}\n  ]\n}\n\n')),(0,r.kt)("p",null,"Then, write a ",(0,r.kt)("inlineCode",{parentName:"p"},"api/serverless.js")," like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"'use strict'\n\nconst build = require('./index')\n\nconst app = build()\n\nmodule.exports = async function (req, res) {\n  await app.ready()\n  app.server.emit('request', req, res)\n}\n\n")),(0,r.kt)("p",null,"And a ",(0,r.kt)("inlineCode",{parentName:"p"},"api/index.js")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"'use strict'\n\nconst fastify = require('fastify')\n\nfunction build () {\n  const app = fastify({\n    logger: true\n  })\n\n  app.get('/', async (req, res) => {\n    const { name = 'World' } = req.query\n    req.log.info({ name }, 'hello world!')\n    return `Hello ${name}!`\n  })\n\n  return app\n}\n\nmodule.exports = build\n\n")),(0,r.kt)("p",null,"Note that you'll need to use Node 10 by setting it in ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'  "engines": {\n    "node": "10.x"\n  },\n\n')))}u.isMDXComponent=!0}}]);