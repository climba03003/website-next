"use strict";(self.webpackChunk_fastify_website=self.webpackChunk_fastify_website||[]).push([[40289],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),m=p(n),u=r,h=m["".concat(l,".").concat(u)]||m[u]||c[u]||i;return n?a.createElement(h,o(o({ref:t},d),{},{components:n})):a.createElement(h,o({ref:t},d))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},61036:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i={},o=void 0,s={unversionedId:"Documentation/Validation-and-Serialization",id:"version-v1.14.x/Documentation/Validation-and-Serialization",title:"Validation-and-Serialization",description:"Validation and Serialization",source:"@site/versioned_docs/version-v1.14.x/Documentation/Validation-and-Serialization.md",sourceDirName:"Documentation",slug:"/Documentation/Validation-and-Serialization",permalink:"/website-next/docs/v1.14.x/Documentation/Validation-and-Serialization",draft:!1,tags:[],version:"v1.14.x",frontMatter:{},sidebar:"docsSidebar",previous:{title:"TypeScript",permalink:"/website-next/docs/v1.14.x/Documentation/TypeScript"},next:{title:"How to write a good plugin",permalink:"/website-next/docs/v1.14.x/Documentation/Write-Plugin"}},l={},p=[{value:"Validation and Serialization",id:"validation-and-serialization",level:2},{value:"Validation",id:"validation",level:3},{value:"Adding a shared schema",id:"adding-a-shared-schema",level:4},{value:"Retrieving a copy of all shared schemas",id:"retrieving-a-copy-of-all-shared-schemas",level:4},{value:"Schema Compiler",id:"schema-compiler",level:4},{value:"Serialization",id:"serialization",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"JSON Schema and Shared Schema support",id:"json-schema-and-shared-schema-support",level:3},{value:"Examples",id:"examples",level:4},{value:"Resources",id:"resources",level:3}],d={toc:p};function c(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"validation-and-serialization"},"Validation and Serialization"),(0,r.kt)("p",null,"Fastify uses a schema-based approach, and even if it is not mandatory we recommend using ",(0,r.kt)("a",{parentName:"p",href:"http://json-schema.org/"},"JSON Schema")," to validate your routes and serialize your outputs. Internally, Fastify compiles the schema into a highly performant function."),(0,r.kt)("a",{name:"validation"}),(0,r.kt)("h3",{id:"validation"},"Validation"),(0,r.kt)("p",null,"The route validation internally relies upon ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/ajv"},"Ajv"),", which is a high-performance JSON schema validator. Validating the input is very easy: just add the fields that you need inside the route schema, and you are done! The supported validations are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"body"),": validates the body of the request if it is a POST or a PUT."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"querystring"),": validates the query string. This can be a complete JSON Schema object (with a ",(0,r.kt)("inlineCode",{parentName:"li"},"type")," property of ",(0,r.kt)("inlineCode",{parentName:"li"},"'object'")," and a ",(0,r.kt)("inlineCode",{parentName:"li"},"'properties'")," object containing parameters) or a simpler variation in which the ",(0,r.kt)("inlineCode",{parentName:"li"},"type")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"properties")," attributes are forgone and the query parameters are listed at the top level (see the example below)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"params"),": validates the route params."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"headers"),": validates the request headers.")),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const schema = {\n  body: {\n    type: 'object',\n    properties: {\n      someKey: { type: 'string' },\n      someOtherKey: { type: 'number' }\n    }\n  },\n\n  querystring: {\n    name: { type: 'string' },\n    excitement: { type: 'integer' }\n  },\n\n  params: {\n    type: 'object',\n    properties: {\n      par1: { type: 'string' },\n      par2: { type: 'number' }\n    }\n  },\n\n  headers: {\n    type: 'object',\n    properties: {\n      'x-foo': { type: 'string' }\n    },\n    required: ['x-foo']\n  }\n}\n\nfastify.post('/the/url', { schema }, handler)\n\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note that Ajv will try to ",(0,r.kt)("a",{parentName:"em",href:"https://github.com/epoberezkin/ajv#coercing-data-types"},"coerce")," the values to the types specified in your schema ",(0,r.kt)("inlineCode",{parentName:"em"},"type")," keywords, both to pass the validation and to use the correctly typed data afterwards.")),(0,r.kt)("a",{name:"shared-schema"}),(0,r.kt)("h4",{id:"adding-a-shared-schema"},"Adding a shared schema"),(0,r.kt)("p",null,"Thanks to the ",(0,r.kt)("inlineCode",{parentName:"p"},"addSchema")," API, you can add multiple schemas to the Fastify instance and then reuse them in multiple parts of your application. ",(0,r.kt)("em",{parentName:"p"},"(Note that this API is not encapsulated)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')()\n\nfastify.addSchema({\n  $id: 'greetings',\n  type: 'object',\n  properties: {\n    hello: { type: 'string' }\n  }\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: 'greetings#'\n  },\n  handler: () => {}\n})\n\n")),(0,r.kt)("p",null,"You can use the shared schema everywhere, as top level schema or nested inside other schemas:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')()\n\nfastify.addSchema({\n  $id: 'greetings',\n  type: 'object',\n  properties: {\n    hello: { type: 'string' }\n  }\n})\n\nfastify.route({\n  method: 'POST',\n  url: '/',\n  schema: {\n    body: {\n      type: 'object',\n      properties: {\n        greeting: 'greetings#',\n        timestamp: { type: 'number' }\n      }\n    }\n  },\n  handler: () => {}\n})\n\n")),(0,r.kt)("a",{name:"get-shared-schema"}),(0,r.kt)("h4",{id:"retrieving-a-copy-of-all-shared-schemas"},"Retrieving a copy of all shared schemas"),(0,r.kt)("p",null,"The function ",(0,r.kt)("inlineCode",{parentName:"p"},"getSchemas")," returns all shared schemas that were added by ",(0,r.kt)("inlineCode",{parentName:"p"},"addSchema")," method."),(0,r.kt)("a",{name:"schema-compiler"}),(0,r.kt)("h4",{id:"schema-compiler"},"Schema Compiler"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"schemaCompiler")," is a function that returns a function that validates the body, url parameters, headers, and query string. The default ",(0,r.kt)("inlineCode",{parentName:"p"},"schemaCompiler")," returns a function that implements the ",(0,r.kt)("a",{parentName:"p",href:"https://ajv.js.org/"},"ajv")," validation interface. Fastify uses it internally to speed the validation up."),(0,r.kt)("p",null,"Fastify's ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/epoberezkin/ajv#options-to-modify-validated-data"},"baseline ajv configuration")," is:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{\n  removeAdditional: true, // remove additional properties\n  useDefaults: true, // replace missing properties and items with the values from corresponding default keyword\n  coerceTypes: true  // change data type of data to match type keyword\n}\n\n")),(0,r.kt)("p",null,"This baseline configuration cannot be modified. If you want to change or set additional config options, you will need to create your own instance and override the existing one like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')()\nconst Ajv = require('ajv')\nconst ajv = new Ajv({\n  // the fastify defaults (if needed)\n  removeAdditional: true,\n  useDefaults: true,\n  coerceTypes: true\n  // any other options\n  // ...\n})\nfastify.setSchemaCompiler(function (schema) {\n  return ajv.compile(schema)\n})\n\n")),(0,r.kt)("p",null,"But maybe you want to change the validation library. Perhaps you like ",(0,r.kt)("inlineCode",{parentName:"p"},"Joi"),". In this case, you can use it to validate the url parameters, body, and query string!"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const Joi = require('joi')\n\nfastify.post('/the/url', {\n  schema: {\n    body: Joi.object().keys({\n      hello: Joi.string().required()\n    }).required()\n  },\n  schemaCompiler: schema => data => Joi.validate(data, schema)\n}, handler)\n\n")),(0,r.kt)("p",null,"In that case the function returned by ",(0,r.kt)("inlineCode",{parentName:"p"},"schemaCompiler")," returns an object like:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"error"),": filled with an instance of ",(0,r.kt)("inlineCode",{parentName:"li"},"Error")," or a string that describes the validation error"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"value"),": the coerced value that passed the validation")),(0,r.kt)("a",{name:"serialization"}),(0,r.kt)("h3",{id:"serialization"},"Serialization"),(0,r.kt)("p",null,"Usually you will send your data to the clients via JSON, and Fastify has a powerful tool to help you, ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/fast-json-stringify"},"fast-json-stringify"),", which is used if you have provided an output schema in the route options. We encourage you to use an output schema, as it will increase your throughput by 100-400% depending on your payload and will prevent accidental disclosure of sensitive information."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const schema = {\n  response: {\n    200: {\n      type: 'object',\n      properties: {\n        value: { type: 'string' },\n        otherValue: { type: 'boolean' }\n      }\n    }\n  }\n}\n\nfastify.post('/the/url', { schema }, handler)\n\n")),(0,r.kt)("p",null,"As you can see, the response schema is based on the status code. If you want to use the same schema for multiple status codes, you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"'2xx'"),", for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const schema = {\n  response: {\n    '2xx': {\n      type: 'object',\n      properties: {\n        value: { type: 'string' },\n        otherValue: { type: 'boolean' }\n      }\n    },\n    201: {\n      type: 'object',\n      properties: {\n        value: { type: 'string' }\n      }\n    }\n  }\n}\n\nfastify.post('/the/url', { schema }, handler)\n\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"If you need a custom serializer in a very specific part of your code, you can set one with ",(0,r.kt)("inlineCode",{parentName:"em"},"reply.serializer(...)"),".")),(0,r.kt)("h3",{id:"error-handling"},"Error Handling"),(0,r.kt)("p",null,"When schema validation fails for a request, Fastify will automtically return a  status 400 response including the result from the validator in the payload. As an example, if you have the following schema for your route"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const schema = {\n  body: {\n    type: 'object',\n    properties: {\n      name: { type: 'string' }\n    },\n    required: ['name']\n  }\n}\n\n")),(0,r.kt)("p",null,"and fail to satisfy it, the route will immediately return a response with the following payload"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'{ \n  "statusCode": 400,\n  "error": "Bad Request",\n  "message": "body should have required property \'name\'" \n}\n\n')),(0,r.kt)("p",null,"If you want to handle errors inside the route, you can specify the ",(0,r.kt)("inlineCode",{parentName:"p"},"attachValidation")," option for your route. If there is a validation error, the ",(0,r.kt)("inlineCode",{parentName:"p"},"validationError")," property of the request will contain the ",(0,r.kt)("inlineCode",{parentName:"p"},"Error")," object with the raw ",(0,r.kt)("inlineCode",{parentName:"p"},"validation")," result as shown below"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = Fastify()\n\nfastify.post('/', { schema, attachValidation: true }, function (req, reply) {\n  if (req.validation) {\n    // `req.validationError.validation` contains the raw validation error\n    reply.code(400).send(req.validationError)\n  }\n})\n\n")),(0,r.kt)("p",null,"You can also use ",(0,r.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Server/#seterrorhandler"},"setErrorHandler")," to define a custom response for validation errors such as"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.setErrorHandler(function (error, request, reply) {\n  if (error.validation) {\n     reply.status(422).send(new Error('validation failed'))\n  }\n})\n\n")),(0,r.kt)("h3",{id:"json-schema-and-shared-schema-support"},"JSON Schema and Shared Schema support"),(0,r.kt)("p",null,"JSON Schema has some type of utilities in order to optimize your schemas that,\nin conjuction with the Fastify's shared schema, let you reuse all your schemas easily."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Use Case"),(0,r.kt)("th",{parentName:"tr",align:null},"Validator"),(0,r.kt)("th",{parentName:"tr",align:null},"Serializer"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"shared schema"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"$ref")," to ",(0,r.kt)("inlineCode",{parentName:"td"},"$id")),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"$ref")," to ",(0,r.kt)("inlineCode",{parentName:"td"},"/definitions")),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"$ref")," to shared schema ",(0,r.kt)("inlineCode",{parentName:"td"},"$id")),(0,r.kt)("td",{parentName:"tr",align:null},"\u274c"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"$ref")," to shared schema ",(0,r.kt)("inlineCode",{parentName:"td"},"/definitions")),(0,r.kt)("td",{parentName:"tr",align:null},"\u274c"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2714\ufe0f")))),(0,r.kt)("h4",{id:"examples"},"Examples"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// Usage of the Shared Schema feature\nfastify.addSchema({\n  $id: 'sharedAddress',\n  type: 'object',\n  properties: {\n    city: { 'type': 'string' }\n  }\n})\n\nconst sharedSchema = {\n  type: 'object',\n  properties: {\n    home: 'sharedAddress#',\n    work: 'sharedAddress#'\n  }\n}\n\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// Usage of $ref to $id in same JSON Schema\nconst refToId = {\n  type: 'object',\n  definitions: {\n    foo: {\n      $id: '#address',\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  },\n  properties: {\n    home: { $ref: '#address' },\n    work: { $ref: '#address' }\n  }\n}\n\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// Usage of $ref to /definitions in same JSON Schema\nconst refToDefinitions = {\n  type: 'object',\n  definitions: {\n    foo: {\n      $id: '#address',\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  },\n  properties: {\n    home: { $ref: '#/definitions/foo' },\n    work: { $ref: '#/definitions/foo' }\n  }\n}\n\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// Usage $ref to a shared schema $id as external schema\nfastify.addSchema({\n  $id: 'http://foo/common.json',\n  type: 'object',\n  definitions: {\n    foo: {\n      $id: '#address',\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  }\n})\n\nconst refToSharedSchemaId = {\n  type: 'object',\n  properties: {\n    home: { $ref: 'http://foo/common.json#address' },\n    work: { $ref: 'http://foo/common.json#address' }\n  }\n}\n\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// Usage $ref to a shared schema /definitions as external schema\nfastify.addSchema({\n  $id: 'http://foo/common.json',\n  type: 'object',\n  definitions: {\n    foo: {\n      type: 'object',\n      properties: {\n        city: { 'type': 'string' }\n      }\n    }\n  }\n})\n\nconst refToSharedSchemaDefinitions = {\n  type: 'object',\n  properties: {\n    home: { $ref: 'http://foo/common.json#/definitions/foo' },\n    work: { $ref: 'http://foo/common.json#/definitions/foo' }\n  }\n}\n\n")),(0,r.kt)("a",{name:"resources"}),(0,r.kt)("h3",{id:"resources"},"Resources"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"http://json-schema.org/"},"JSON Schema")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://spacetelescope.github.io/understanding-json-schema/"},"Understanding JSON schema")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/fastify/fast-json-stringify"},"fast-json-stringify documentation")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/epoberezkin/ajv/blob/master/README.md"},"Ajv documentation"))))}c.isMDXComponent=!0}}]);