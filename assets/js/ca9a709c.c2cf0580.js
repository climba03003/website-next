"use strict";(self.webpackChunk_fastify_website=self.webpackChunk_fastify_website||[]).push([[17020],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,f=c["".concat(l,".").concat(m)]||c[m]||u[m]||i;return n?a.createElement(f,o(o({ref:t},d),{},{components:n})):a.createElement(f,o({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},26192:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i={},o=void 0,s={unversionedId:"Documentation/Server",id:"version-v2.15.x/Documentation/Server",title:"Server",description:"Factory",source:"@site/versioned_docs/version-v2.15.x/Documentation/Server.md",sourceDirName:"Documentation",slug:"/Documentation/Server",permalink:"/website-next/docs/v2.15.x/Documentation/Server",draft:!1,tags:[],version:"v2.15.x",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Routes",permalink:"/website-next/docs/v2.15.x/Documentation/Routes"},next:{title:"Serverless",permalink:"/website-next/docs/v2.15.x/Documentation/Serverless"}},l={},p=[{value:"Factory",id:"factory",level:2},{value:"<code>http2</code>",id:"http2",level:3},{value:"<code>https</code>",id:"https",level:3},{value:"<code>ignoreTrailingSlash</code>",id:"ignoretrailingslash",level:3},{value:"<code>maxParamLength</code>",id:"maxparamlength",level:3},{value:"<code>bodyLimit</code>",id:"bodylimit",level:3},{value:"<code>onProtoPoisoning</code>",id:"onprotopoisoning",level:3},{value:"<code>onConstructorPoisoning</code>",id:"onconstructorpoisoning",level:3},{value:"<code>logger</code>",id:"logger",level:3},{value:"<code>disableRequestLogging</code>",id:"disablerequestlogging",level:3},{value:"<code>serverFactory</code>",id:"serverfactory",level:3},{value:"<code>caseSensitive</code>",id:"casesensitive",level:3},{value:"<code>requestIdHeader</code>",id:"requestidheader",level:3},{value:"<code>requestIdLogLabel</code>",id:"requestidloglabel",level:3},{value:"<code>genReqId</code>",id:"genreqid",level:3},{value:"<code>trustProxy</code>",id:"trustproxy",level:3},{value:"<code>pluginTimeout</code>",id:"plugintimeout",level:3},{value:"<code>querystringParser</code>",id:"querystringparser",level:3},{value:"<code>versioning</code>",id:"versioning",level:3},{value:"<code>modifyCoreObjects</code>",id:"modifycoreobjects",level:3},{value:"<code>return503OnClosing</code>",id:"return503onclosing",level:3},{value:"<code>ajv</code>",id:"ajv",level:3},{value:"<code>http2SessionTimeout</code>",id:"http2sessiontimeout",level:3},{value:"<code>frameworkErrors</code>",id:"frameworkerrors",level:3},{value:"Instance",id:"instance",level:2},{value:"Server Methods",id:"server-methods",level:3},{value:"server",id:"server",level:4},{value:"after",id:"after",level:4},{value:"ready",id:"ready",level:4},{value:"listen",id:"listen",level:4},{value:"route",id:"route",level:4},{value:"close",id:"close",level:4},{value:"decorate*",id:"decorate",level:4},{value:"register",id:"register",level:4},{value:"use",id:"use",level:4},{value:"addHook",id:"addhook",level:4},{value:"prefix",id:"prefix",level:4},{value:"pluginName",id:"pluginname",level:4},{value:"log",id:"log",level:4},{value:"inject",id:"inject",level:4},{value:"addSchema",id:"addschema",level:4},{value:"setReplySerializer",id:"setreplyserializer",level:4},{value:"setSchemaCompiler",id:"setschemacompiler",level:4},{value:"setSchemaResolver",id:"setschemaresolver",level:4},{value:"schemaCompiler",id:"schemacompiler",level:4},{value:"setNotFoundHandler",id:"setnotfoundhandler",level:4},{value:"setErrorHandler",id:"seterrorhandler",level:4},{value:"printRoutes",id:"printroutes",level:4},{value:"initialConfig",id:"initialconfig",level:4}],d={toc:p};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("a",{name:"factory"}),(0,r.kt)("h2",{id:"factory"},"Factory"),(0,r.kt)("p",null,"The Fastify module exports a factory function that is used to create new"),(0,r.kt)("a",{href:"https://github.com/fastify/fastify/blob/master/docs/Server.md"},(0,r.kt)("code",null,(0,r.kt)("b",null,"Fastify server"))),"instances. This factory function accepts an options object which is used to customize the resulting instance. This document describes the properties available in that options object.",(0,r.kt)("a",{name:"factory-http2"}),(0,r.kt)("h3",{id:"http2"},(0,r.kt)("inlineCode",{parentName:"h3"},"http2")),(0,r.kt)("p",null,"If ",(0,r.kt)("inlineCode",{parentName:"p"},"true")," Node.js core's ",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/dist/latest-v8.x/docs/api/http2.html"},"HTTP/2")," module is used for binding the socket."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"false"))),(0,r.kt)("a",{name:"factory-https"}),(0,r.kt)("h3",{id:"https"},(0,r.kt)("inlineCode",{parentName:"h3"},"https")),(0,r.kt)("p",null,"An object used to configure the server's listening socket for TLS. The options\nare the same as the Node.js core\n",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/dist/latest-v8.x/docs/api/https.html#https_https_createserver_options_requestlistener"},(0,r.kt)("inlineCode",{parentName:"a"},"createServer")," method"),".\nWhen this property is ",(0,r.kt)("inlineCode",{parentName:"p"},"null"),", the socket will not be configured for TLS."),(0,r.kt)("p",null,"This option also applies when the"),(0,r.kt)("a",{href:"https://github.com/fastify/fastify/blob/master/docs/Server.md#factory-http2"},(0,r.kt)("code",null,(0,r.kt)("b",null,"http2")))," option is set.",(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"null"))),(0,r.kt)("a",{name:"factory-ignore-slash"}),(0,r.kt)("h3",{id:"ignoretrailingslash"},(0,r.kt)("inlineCode",{parentName:"h3"},"ignoreTrailingSlash")),(0,r.kt)("p",null,"Fastify uses ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/delvedor/find-my-way"},"find-my-way")," to handle\nrouting. This option may be set to ",(0,r.kt)("inlineCode",{parentName:"p"},"true")," to ignore trailing slashes in routes.\nThis option applies to ",(0,r.kt)("em",{parentName:"p"},"all")," route registrations for the resulting server\ninstance."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"false"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')({\n  ignoreTrailingSlash: true\n})\n\n// registers both \"/foo\" and \"/foo/\"\nfastify.get('/foo/', function (req, reply) {\n  reply.send('foo')\n})\n\n// registers both \"/bar\" and \"/bar/\"\nfastify.get('/bar', function (req, reply) {\n  reply.send('bar')\n})\n\n")),(0,r.kt)("a",{name:"factory-max-param-length"}),(0,r.kt)("h3",{id:"maxparamlength"},(0,r.kt)("inlineCode",{parentName:"h3"},"maxParamLength")),(0,r.kt)("p",null,"You can set a custom length for parameters in parametric (standard, regex and multi) routes by using ",(0,r.kt)("inlineCode",{parentName:"p"},"maxParamLength")," option, the default value is 100 characters.",(0,r.kt)("br",null),"\nThis can be useful especially if you have some regex based route, protecting you against ",(0,r.kt)("a",{parentName:"p",href:"https://www.owasp.org/index.php/Regular_expression_Denial_of_Service_-_ReDoS"},"DoS attacks"),".",(0,r.kt)("br",null),"\n",(0,r.kt)("em",{parentName:"p"},"If the maximum length limit is reached, the not found route will be invoked.")),(0,r.kt)("a",{name:"factory-body-limit"}),(0,r.kt)("h3",{id:"bodylimit"},(0,r.kt)("inlineCode",{parentName:"h3"},"bodyLimit")),(0,r.kt)("p",null,"Defines the maximum payload, in bytes, the server is allowed to accept."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"1048576")," (1MiB)")),(0,r.kt)("a",{name:"factory-on-proto-poisoning"}),(0,r.kt)("h3",{id:"onprotopoisoning"},(0,r.kt)("inlineCode",{parentName:"h3"},"onProtoPoisoning")),(0,r.kt)("p",null,"Defines what action the framework must take when parsing a JSON object\nwith ",(0,r.kt)("inlineCode",{parentName:"p"},"__proto__"),". This functionality is provided by\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/secure-json-parse"},"secure-json-parse"),".\nSee ",(0,r.kt)("a",{parentName:"p",href:"https://hueniverse.com/a-tale-of-prototype-poisoning-2610fa170061"},"https://hueniverse.com/a-tale-of-prototype-poisoning-2610fa170061"),"\nfor more details about prototype poisoning attacks."),(0,r.kt)("p",null,"Possible values are ",(0,r.kt)("inlineCode",{parentName:"p"},"'error'"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"'remove'")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"'ignore'"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"'error'"))),(0,r.kt)("a",{name:"factory-on-constructor-poisoning"}),(0,r.kt)("h3",{id:"onconstructorpoisoning"},(0,r.kt)("inlineCode",{parentName:"h3"},"onConstructorPoisoning")),(0,r.kt)("p",null,"Defines what action the framework must take when parsing a JSON object\nwith ",(0,r.kt)("inlineCode",{parentName:"p"},"constructor"),". This functionality is provided by\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/secure-json-parse"},"secure-json-parse"),".\nSee ",(0,r.kt)("a",{parentName:"p",href:"https://hueniverse.com/a-tale-of-prototype-poisoning-2610fa170061"},"https://hueniverse.com/a-tale-of-prototype-poisoning-2610fa170061"),"\nfor more details about prototype poisoning attacks."),(0,r.kt)("p",null,"Possible values are ",(0,r.kt)("inlineCode",{parentName:"p"},"'error'"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"'remove'")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"'ignore'"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"'ignore'"))),(0,r.kt)("a",{name:"factory-logger"}),(0,r.kt)("h3",{id:"logger"},(0,r.kt)("inlineCode",{parentName:"h3"},"logger")),(0,r.kt)("p",null,"Fastify includes built-in logging via the ",(0,r.kt)("a",{parentName:"p",href:"https://getpino.io/"},"Pino")," logger.\nThis property is used to configure the internal logger instance."),(0,r.kt)("p",null,"The possible values this property may have are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Default: ",(0,r.kt)("inlineCode",{parentName:"p"},"false"),". The logger is disabled. All logging methods will point to a\nnull logger ",(0,r.kt)("a",{parentName:"p",href:"https://npm.im/abstract-logging"},"abstract-logging")," instance.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"pinoInstance"),": a previously instantiated instance of Pino. The internal\nlogger will point to this instance.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"object"),": a standard Pino ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/pinojs/pino/blob/c77d8ec5ce/docs/API.md#constructor"},"options object"),".\nThis will be passed directly to the Pino constructor. If the following properties\nare not present on the object, they will be added accordingly:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre"},"* `genReqId`: a synchronous function that will be used to generate identifiers\nfor incoming requests. The default function generates sequential identifiers.\n* `level`: the minimum logging level. If not set, it will be set to `'info'`.\n* `serializers`: a hash of serialization functions. By default, serializers\n  are added for `req` (incoming request objects), `res` (outgoing response\n  objets), and `err` (standard `Error` objects). When a log method receives\n  an object with any of these properties then the respective serializer will\n  be used for that property. For example:\n    \n")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"        fastify.get('/foo', function (req, res) {\n          req.log.info({req}) // log the serialized request object\n          res.send('foo')\n        })\n        \n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"  Any user supplied serializer will override the default serializer of the\n  corresponding property.\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"loggerInstance"),": a custom logger instance. The logger must conform to the Pino\ninterface by having the following methods: ",(0,r.kt)("inlineCode",{parentName:"li"},"info"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"error"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"debug"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"fatal"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"warn"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"trace"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"child"),". For example:\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"  const pino = require('pino')();\n\n  const customLogger = {\n    info: function (o, ...n) {},\n    warn: function (o, ...n) {},\n    error: function (o, ...n) {},\n    fatal: function (o, ...n) {},\n    trace: function (o, ...n) {},\n    debug: function (o, ...n) {},\n    child: function() {\n      const child = Object.create(this);\n      child.pino = pino.child(...arguments);\n      return child;\n    },\n  };\n\n  const fastify = require('fastify')({logger: customLogger});\n  \n")),(0,r.kt)("a",{name:"factory-disable-request-logging"}),(0,r.kt)("h3",{id:"disablerequestlogging"},(0,r.kt)("inlineCode",{parentName:"h3"},"disableRequestLogging")),(0,r.kt)("p",null,"By default, when logging is enabled, Fastify will issue an ",(0,r.kt)("inlineCode",{parentName:"p"},"info")," level log\nmessage when a request is received and when the response for that request has\nbeen sent. By setting this option to ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),", these log messages will be disabled.\nThis allows for more flexible request start and end logging by attaching\ncustom ",(0,r.kt)("inlineCode",{parentName:"p"},"onRequest")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"onResponse")," hooks."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"false"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// Examples of hooks to replicate the disabled functionality.\nfastify.addHook('onRequest', (req, reply, done) => {\n  req.log.info({ url: req.req.url, id: req.id }, 'received request')\n  done()\n})\n\nfastify.addHook('onResponse', (req, reply, done) => {\n  req.log.info({ url: req.req.originalUrl, statusCode: reply.res.statusCode }, 'request completed')\n  done()\n})\n\n")),(0,r.kt)("a",{name:"custom-http-server"}),(0,r.kt)("h3",{id:"serverfactory"},(0,r.kt)("inlineCode",{parentName:"h3"},"serverFactory")),(0,r.kt)("p",null,"You can pass a custom http server to Fastify by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"serverFactory")," option.",(0,r.kt)("br",null),"\n",(0,r.kt)("inlineCode",{parentName:"p"},"serverFactory")," is a function that takes an ",(0,r.kt)("inlineCode",{parentName:"p"},"handler")," parameter, which takes the ",(0,r.kt)("inlineCode",{parentName:"p"},"request")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"response")," objects as parameters, and an options object, which is the same you have passed to Fastify."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const serverFactory = (handler, opts) => {\n  const server = http.createServer((req, res) => {\n    handler(req, res)\n  })\n\n  return server\n}\n\nconst fastify = Fastify({ serverFactory, modifyCoreObjects: false })\n\nfastify.get('/', (req, reply) => {\n  reply.send({ hello: 'world' })\n})\n\nfastify.listen(3000)\n\n")),(0,r.kt)("p",null,"Internally Fastify uses the API of Node core http server, so if you are using a custom server you must be sure to have the same API exposed. If not, you can enhance the server instance inside the ",(0,r.kt)("inlineCode",{parentName:"p"},"serverFactory")," function before the ",(0,r.kt)("inlineCode",{parentName:"p"},"return")," statement.",(0,r.kt)("br",null),"\n",(0,r.kt)("em",{parentName:"p"},"Note that we have also added ",(0,r.kt)("inlineCode",{parentName:"em"},"modifyCoreObjects: false")," because in some serverless environments such as Google Cloud Functions, some Node.js core properties are not writable.")),(0,r.kt)("a",{name:"factory-case-sensitive"}),(0,r.kt)("h3",{id:"casesensitive"},(0,r.kt)("inlineCode",{parentName:"h3"},"caseSensitive")),(0,r.kt)("p",null,"By default, value equal to ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),", routes are registered as case sensitive. That is, ",(0,r.kt)("inlineCode",{parentName:"p"},"/foo")," is not equivalent to ",(0,r.kt)("inlineCode",{parentName:"p"},"/Foo"),". When set to ",(0,r.kt)("inlineCode",{parentName:"p"},"false"),", routes are registered in a fashion such that ",(0,r.kt)("inlineCode",{parentName:"p"},"/foo")," is equivalent to ",(0,r.kt)("inlineCode",{parentName:"p"},"/Foo")," which is equivalent to ",(0,r.kt)("inlineCode",{parentName:"p"},"/FOO"),"."),(0,r.kt)("p",null,"By setting ",(0,r.kt)("inlineCode",{parentName:"p"},"caseSensitive")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"false"),", all paths will be matched as lowercase, but the route parameters or wildcards will maintain their original letter casing."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.get('/user/:username', (request, reply) => {\n  // Given the URL: /USER/NodeJS\n  console.log(request.params.username) // -> 'NodeJS'\n})\n\n")),(0,r.kt)("p",null,"Please note this setting this option to ",(0,r.kt)("inlineCode",{parentName:"p"},"false")," goes against\n",(0,r.kt)("a",{parentName:"p",href:"https://tools.ietf.org/html/rfc3986#section-6.2.2.1"},"RFC3986"),"."),(0,r.kt)("a",{name:"factory-request-id-header"}),(0,r.kt)("h3",{id:"requestidheader"},(0,r.kt)("inlineCode",{parentName:"h3"},"requestIdHeader")),(0,r.kt)("p",null,"The header name used to know the request id. See ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Logging.md#logging-request-id"},"the request id")," section."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"'request-id'"))),(0,r.kt)("a",{name:"factory-request-id-log-label"}),(0,r.kt)("h3",{id:"requestidloglabel"},(0,r.kt)("inlineCode",{parentName:"h3"},"requestIdLogLabel")),(0,r.kt)("p",null,"Defines the label used for the request identifier when logging the request."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"'reqId'"))),(0,r.kt)("a",{name:"factory-gen-request-id"}),(0,r.kt)("h3",{id:"genreqid"},(0,r.kt)("inlineCode",{parentName:"h3"},"genReqId")),(0,r.kt)("p",null,"Function for generating the request id. It will receive the incoming request as a parameter."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"value of 'request-id' header if provided or monotonically increasing integers"))),(0,r.kt)("p",null,"Especially in distributed systems, you may want to override the default id generation behaviour as shown below. For generating ",(0,r.kt)("inlineCode",{parentName:"p"},"UUID"),"s you may want to checkout ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/mcollina/hyperid"},"hyperid")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"let i = 0\nconst fastify = require('fastify')({\n  genReqId: function (req) { return i++ }\n})\n\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note: genReqId will ",(0,r.kt)("em",{parentName:"strong"},"not")," be called if the header set in ",(0,r.kt)("code",null,(0,r.kt)("a",{parentName:"strong",href:"#requestidheader"},"requestIdHeader"))," is available (defaults to 'request-id').")),(0,r.kt)("a",{name:"factory-trust-proxy"}),(0,r.kt)("h3",{id:"trustproxy"},(0,r.kt)("inlineCode",{parentName:"h3"},"trustProxy")),(0,r.kt)("p",null,"By enabling the ",(0,r.kt)("inlineCode",{parentName:"p"},"trustProxy")," option, Fastify will have knowledge that it's sitting behind a proxy and that the ",(0,r.kt)("inlineCode",{parentName:"p"},"X-Forwarded-*")," header fields may be trusted, which otherwise may be easily spoofed."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = Fastify({ trustProxy: true })\n\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"false")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"true/false"),": Trust all proxies (",(0,r.kt)("inlineCode",{parentName:"li"},"true"),") or do not trust any proxies (",(0,r.kt)("inlineCode",{parentName:"li"},"false"),")."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"string"),": Trust only given IP/CIDR (e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"'127.0.0.1'"),"). May be a list of comma separated values (e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"'127.0.0.1,192.168.1.1/24'"),")."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Array<string>"),": Trust only given IP/CIDR list (e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"['127.0.0.1']"),")."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"number"),": Trust the nth hop from the front-facing proxy server as the client."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"Function"),": Custom trust function that takes ",(0,r.kt)("inlineCode",{parentName:"li"},"address")," as first arg\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"    function myTrustFn(address, hop) {\n      return address === '1.2.3.4' || hop === 1\n    }\n    \n")),(0,r.kt)("p",null,"For more examples refer to ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/proxy-addr"},"proxy-addr")," package."),(0,r.kt)("p",null,"You may access the ",(0,r.kt)("inlineCode",{parentName:"p"},"ip"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"ips"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"hostname")," values on the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Request.md"},(0,r.kt)("inlineCode",{parentName:"a"},"request"))," object."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.get('/', (request, reply) => {\n  console.log(request.ip)\n  console.log(request.ips)\n  console.log(request.hostname)\n})\n\n")),(0,r.kt)("a",{name:"plugin-timeout"}),(0,r.kt)("h3",{id:"plugintimeout"},(0,r.kt)("inlineCode",{parentName:"h3"},"pluginTimeout")),(0,r.kt)("p",null,"The maximum amount of time in ",(0,r.kt)("em",{parentName:"p"},"milliseconds")," in which a plugin can load.\nIf not, ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Server.md#ready"},(0,r.kt)("inlineCode",{parentName:"a"},"ready")),"\nwill complete with an ",(0,r.kt)("inlineCode",{parentName:"p"},"Error")," with code ",(0,r.kt)("inlineCode",{parentName:"p"},"'ERR_AVVIO_PLUGIN_TIMEOUT'"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"10000"))),(0,r.kt)("a",{name:"factory-querystring-parser"}),(0,r.kt)("h3",{id:"querystringparser"},(0,r.kt)("inlineCode",{parentName:"h3"},"querystringParser")),(0,r.kt)("p",null,"The default query string parser that Fastify uses is the Node.js's core ",(0,r.kt)("inlineCode",{parentName:"p"},"querystring")," module.",(0,r.kt)("br",null),"\nYou can change this default setting by passing the option ",(0,r.kt)("inlineCode",{parentName:"p"},"querystringParser")," and use a custom one, such as ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/qs"},(0,r.kt)("inlineCode",{parentName:"a"},"qs")),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const qs = require('qs')\nconst fastify = require('fastify')({\n  querystringParser: str => qs.parse(str)\n})\n\n")),(0,r.kt)("a",{name:"versioning"}),(0,r.kt)("h3",{id:"versioning"},(0,r.kt)("inlineCode",{parentName:"h3"},"versioning")),(0,r.kt)("p",null,"By default you can version your routes with ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Routes.md#version"},"semver versioning"),", which is provided by ",(0,r.kt)("inlineCode",{parentName:"p"},"find-my-way"),". There is still an option to provide custom versioning strategy. You can find more information in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/delvedor/find-my-way#versioned-routes"},"find-my-way")," documentation."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const versioning = {\n  storage: function () {\n    let versions = {}\n    return {\n      get: (version) => { return versions[version] || null },\n      set: (version, store) => { versions[version] = store },\n      del: (version) => { delete versions[version] },\n      empty: () => { versions = {} }\n    }\n  },\n  deriveVersion: (req, ctx) => {\n    return req.headers['accept']\n  }\n}\n\nconst fastify = require('fastify')({\n  versioning\n})\n\n")),(0,r.kt)("a",{name:"factory-modify-core-objects"}),(0,r.kt)("h3",{id:"modifycoreobjects"},(0,r.kt)("inlineCode",{parentName:"h3"},"modifyCoreObjects")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"true"))),(0,r.kt)("p",null,"By default, Fastify will add the ",(0,r.kt)("inlineCode",{parentName:"p"},"ip"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"ips"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"hostname"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"log")," properties to Node's raw request object (see ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Request.md"},(0,r.kt)("inlineCode",{parentName:"a"},"Request")),") and the ",(0,r.kt)("inlineCode",{parentName:"p"},"log")," property to Node's raw response object. Set to ",(0,r.kt)("inlineCode",{parentName:"p"},"false")," to prevent these properties from being added to the Node core objects."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = Fastify({ modifyCoreObjects: true }) // the default\n\nfastify.get('/', (request, reply) => {\n  console.log(request.raw.ip)\n  console.log(request.raw.ips)\n  console.log(request.raw.hostname)\n  request.raw.log('Hello')\n  reply.res.log('World')\n})\n\n")),(0,r.kt)("p",null,"Disable this option could help in serverless environments such as Google Cloud Functions, where ",(0,r.kt)("inlineCode",{parentName:"p"},"ip")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"ips")," are not writable properties."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note that these properties are deprecated and will be removed in the next major version of Fastify along with this option.")," It is recommended to use the same properties on Fastify's ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Request.md"},(0,r.kt)("inlineCode",{parentName:"a"},"Request"))," and ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Reply.md"},(0,r.kt)("inlineCode",{parentName:"a"},"Reply"))," objects instead."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = Fastify({ modifyCoreObjects: false })\n\nfastify.get('/', (request, reply) => {\n  console.log(request.ip)\n  console.log(request.ips)\n  console.log(request.hostname)\n  request.log('Hello')\n  reply.log('World')\n})\n\n")),(0,r.kt)("a",{name:"factory-return-503-on-closing"}),(0,r.kt)("h3",{id:"return503onclosing"},(0,r.kt)("inlineCode",{parentName:"h3"},"return503OnClosing")),(0,r.kt)("p",null,"Returns 503 after calling ",(0,r.kt)("inlineCode",{parentName:"p"},"close")," server method.\nIf ",(0,r.kt)("inlineCode",{parentName:"p"},"false"),", the server routes the incoming request as usual."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"true"))),(0,r.kt)("a",{name:"factory-ajv"}),(0,r.kt)("h3",{id:"ajv"},(0,r.kt)("inlineCode",{parentName:"h3"},"ajv")),(0,r.kt)("p",null,"Configure the ajv instance used by Fastify without providing a custom one."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"{\n  customOptions: {\n    removeAdditional: true,\n    useDefaults: true,\n    coerceTypes: true,\n    allErrors: true,\n    nullable: true\n  },\n  plugins: []\n}\n\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')({\n  ajv: {\n    customOptions: {\n      nullable: false // Refer to [ajv options](https://ajv.js.org/#options)\n    },\n    plugins: [\n      require('ajv-merge-patch')\n      [require('ajv-keywords'), 'instanceof'];\n      // Usage: [plugin, pluginOptions] - Plugin with options\n      // Usage: plugin - Plugin without options\n    ]\n  }\n})\n\n")),(0,r.kt)("a",{name:"http2-session-timeout"}),(0,r.kt)("h3",{id:"http2sessiontimeout"},(0,r.kt)("inlineCode",{parentName:"h3"},"http2SessionTimeout")),(0,r.kt)("p",null,"Set a default\n",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/api/http2.html#http2_http2session_settimeout_msecs_callback"},"timeout")," to every incoming http2 session. The session will be closed on the timeout. Default: ",(0,r.kt)("inlineCode",{parentName:"p"},"5000")," ms."),(0,r.kt)("p",null,'Note that this is needed to offer the graceful "close" experience when\nusing http2. Node core defaults this to ',(0,r.kt)("inlineCode",{parentName:"p"},"0"),"."),(0,r.kt)("a",{name:"framework-errors"}),(0,r.kt)("h3",{id:"frameworkerrors"},(0,r.kt)("inlineCode",{parentName:"h3"},"frameworkErrors")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Default: ",(0,r.kt)("inlineCode",{parentName:"li"},"null"))),(0,r.kt)("p",null,"Fastify provides default error handlers for the most common use cases.\nUsing this option it is possible to override one or more of those handlers with custom code."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note: Only ",(0,r.kt)("inlineCode",{parentName:"em"},"FST_ERR_BAD_URL")," is implemented at the moment.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fastify = require('fastify')({\n  frameworkErrors: function (error, req, res) {\n    if (error instanceof FST_ERR_BAD_URL) {\n      res.code(400)\n      return res.send(\"Provided url is not valid\")\n    } else {\n      res.send(err)\n    }\n  }\n})\n\n")),(0,r.kt)("h2",{id:"instance"},"Instance"),(0,r.kt)("h3",{id:"server-methods"},"Server Methods"),(0,r.kt)("a",{name:"server"}),(0,r.kt)("h4",{id:"server"},"server"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fastify.server"),": The Node core ",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/api/http.html#http_class_http_server"},"server")," object as returned by the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Server.md"},(0,r.kt)("strong",{parentName:"a"},(0,r.kt)("inlineCode",{parentName:"strong"},"Fastify factory function"))),"."),(0,r.kt)("a",{name:"after"}),(0,r.kt)("h4",{id:"after"},"after"),(0,r.kt)("p",null,"Invoked when the current plugin and all the plugins\nthat have been registered within it have finished loading.\nIt is always executed before the method ",(0,r.kt)("inlineCode",{parentName:"p"},"fastify.ready"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify\n  .register((instance, opts, done) => {\n    console.log('Current plugin')\n    done()\n  })\n  .after(err => {\n    console.log('After current plugin')\n  })\n  .register((instance, opts, done) => {\n    console.log('Next plugin')\n    done()\n  })\n  .ready(err => {\n    console.log('Everything has been loaded')\n  })\n\n")),(0,r.kt)("a",{name:"ready"}),(0,r.kt)("h4",{id:"ready"},"ready"),(0,r.kt)("p",null,"Function called when all the plugins have been loaded.\nIt takes an error parameter if something went wrong."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.ready(err => {\n  if (err) throw err\n})\n\n")),(0,r.kt)("p",null,"If it is called without any arguments, it will return a ",(0,r.kt)("inlineCode",{parentName:"p"},"Promise"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.ready().then(() => {\n  console.log('successfully booted!')\n}, (err) => {\n  console.log('an error happened', err)\n})\n\n")),(0,r.kt)("a",{name:"listen"}),(0,r.kt)("h4",{id:"listen"},"listen"),(0,r.kt)("p",null,"Starts the server on the given port after all the plugins are loaded, internally waits for the ",(0,r.kt)("inlineCode",{parentName:"p"},".ready()")," event. The callback is the same as the Node core. By default, the server will listen on the address resolved by ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost")," when no specific address is provided (",(0,r.kt)("inlineCode",{parentName:"p"},"127.0.0.1")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"::1")," depending on the operating system). If listening on any available interface is desired, then specifying ",(0,r.kt)("inlineCode",{parentName:"p"},"0.0.0.0")," for the address will listen on all IPv4 address. Using ",(0,r.kt)("inlineCode",{parentName:"p"},"::")," for the address will listen on all IPv6 addresses, and, depending on OS, may also listen on all IPv4 addresses. Be careful when deciding to listen on all interfaces; it comes with inherent ",(0,r.kt)("a",{parentName:"p",href:"https://web.archive.org/web/20170831174611/https://snyk.io/blog/mongodb-hack-and-secure-defaults/"},"security risks"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen(3000, (err, address) => {\n  if (err) {\n    fastify.log.error(err)\n    process.exit(1)\n  }\n})\n\n")),(0,r.kt)("p",null,"Specifying an address is also supported:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen(3000, '127.0.0.1', (err, address) => {\n  if (err) {\n    fastify.log.error(err)\n    process.exit(1)\n  }\n})\n\n")),(0,r.kt)("p",null,"Specifying a backlog queue size is also supported:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen(3000, '127.0.0.1', 511, (err, address) => {\n  if (err) {\n    fastify.log.error(err)\n    process.exit(1)\n  }\n})\n\n")),(0,r.kt)("p",null,"Specifying options is also supported, the object is same as ",(0,r.kt)("a",{parentName:"p",href:"https://nodejs.org/api/net.html#net_server_listen_options_callback"},"options")," in the Node.js server listen:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen({ port: 3000, host: '127.0.0.1', backlog: 511 }, (err) => {\n  if (err) {\n    fastify.log.error(err)\n    process.exit(1)\n  }\n})\n\n")),(0,r.kt)("p",null,"If no callback is provided a Promise is returned:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen(3000)\n  .then((address) => console.log(`server listening on ${address}`))\n  .catch(err => {\n    console.log('Error starting server:', err)\n    process.exit(1)\n  })\n\n")),(0,r.kt)("p",null,"Specifying an address without a callback is also supported:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen(3000, '127.0.0.1')\n  .then((address) => console.log(`server listening on ${address}`))\n  .catch(err => {\n    console.log('Error starting server:', err)\n    process.exit(1)\n  })\n\n")),(0,r.kt)("p",null,"Specifying options without a callback is also supported:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen({ port: 3000, host: '127.0.0.1', backlog: 511 })\n  .then((address) => console.log(`server listening on ${address}`))\n  .catch(err => {\n    console.log('Error starting server:', err)\n    process.exit(1)\n  })\n\n")),(0,r.kt)("p",null,"When deploying to a Docker, and potentially other, containers, it is advisable to listen on ",(0,r.kt)("inlineCode",{parentName:"p"},"0.0.0.0")," because they do not default to exposing mapped ports to ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen(3000, '0.0.0.0', (err, address) => {\n  if (err) {\n    fastify.log.error(err)\n    process.exit(1)\n  }\n})\n\n")),(0,r.kt)("p",null,"If the ",(0,r.kt)("inlineCode",{parentName:"p"},"port")," is omitted (or is set to zero), a random available port is automatically chosen (later available via ",(0,r.kt)("inlineCode",{parentName:"p"},"fastify.server.address().port"),")."),(0,r.kt)("p",null,"The default options of listen are:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.listen({\n  port: 0,\n  host: 'localhost',\n  exclusive: false,\n  readableAll: false,\n  writableAll: false,\n  ipv6Only: false\n}, (err) => {})\n\n")),(0,r.kt)("a",{name:"route"}),(0,r.kt)("h4",{id:"route"},"route"),(0,r.kt)("p",null,"Method to add routes to the server, it also has shorthand functions, check ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Routes.md"},"here"),"."),(0,r.kt)("a",{name:"close"}),(0,r.kt)("h4",{id:"close"},"close"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fastify.close(callback)"),": call this function to close the server instance and run the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Hooks.md#on-close"},(0,r.kt)("inlineCode",{parentName:"a"},"'onClose'"))," hook.",(0,r.kt)("br",null),"\nCalling ",(0,r.kt)("inlineCode",{parentName:"p"},"close")," will also cause the server to respond to every new incoming request with a ",(0,r.kt)("inlineCode",{parentName:"p"},"503")," error and destroy that request.\nSee ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Server.md#factory-return-503-on-closing"},(0,r.kt)("inlineCode",{parentName:"a"},"return503OnClosing")," flags")," for changing this behaviour."),(0,r.kt)("p",null,"If it is called without any arguments, it will return a Promise:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.close().then(() => {\n  console.log('successfully closed!')\n}, (err) => {\n  console.log('an error happened', err)\n})\n\n")),(0,r.kt)("a",{name:"decorate"}),(0,r.kt)("h4",{id:"decorate"},"decorate*"),(0,r.kt)("p",null,"Function useful if you need to decorate the fastify instance, Reply or Request, check ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Decorators.md"},"here"),"."),(0,r.kt)("a",{name:"register"}),(0,r.kt)("h4",{id:"register"},"register"),(0,r.kt)("p",null,"Fastify allows the user to extend its functionality with plugins.\nA plugin can be a set of routes, a server decorator or whatever, check ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Plugins.md"},"here"),"."),(0,r.kt)("a",{name:"use"}),(0,r.kt)("h4",{id:"use"},"use"),(0,r.kt)("p",null,"Function to add middlewares to Fastify, check ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Middleware.md"},"here"),"."),(0,r.kt)("a",{name:"addHook"}),(0,r.kt)("h4",{id:"addhook"},"addHook"),(0,r.kt)("p",null,"Function to add a specific hook in the lifecycle of Fastify, check ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Hooks.md"},"here"),"."),(0,r.kt)("a",{name:"prefix"}),(0,r.kt)("h4",{id:"prefix"},"prefix"),(0,r.kt)("p",null,"The full path that will be prefixed to a route."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.register(function (instance, opts, done) {\n  instance.get('/foo', function (request, reply) {\n    // Will log \"prefix: /v1\"\n    request.log.info('prefix: %s', instance.prefix)\n    reply.send({ prefix: instance.prefix })\n  })\n\n  instance.register(function (instance, opts, done) {\n    instance.get('/bar', function (request, reply) {\n      // Will log \"prefix: /v1/v2\"\n      request.log.info('prefix: %s', instance.prefix)\n      reply.send({ prefix: instance.prefix })\n    })\n\n    done()\n  }, { prefix: '/v2' })\n\n  done()\n}, { prefix: '/v1' })\n\n")),(0,r.kt)("a",{name:"pluginName"}),(0,r.kt)("h4",{id:"pluginname"},"pluginName"),(0,r.kt)("p",null,"Name of the current plugin. There are three ways to define a name (in order)."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"If you use ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/fastify/fastify-plugin"},"fastify-plugin")," the metadata ",(0,r.kt)("inlineCode",{parentName:"li"},"name")," is used."),(0,r.kt)("li",{parentName:"ol"},"If you ",(0,r.kt)("inlineCode",{parentName:"li"},"module.exports")," a plugin the filename is used."),(0,r.kt)("li",{parentName:"ol"},"If you use a regular ",(0,r.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Functions#Defining_functions"},"function declaration")," the function name is used.")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Fallback"),": The first two lines of your plugin will represent the plugin name. Newlines are replaced by ",(0,r.kt)("inlineCode",{parentName:"p"},"--"),". This will help to indentify the root cause when you deal with many plugins."),(0,r.kt)("p",null,"Important: If you have to deal with nested plugins the name differs with the usage of the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify-plugin"},"fastify-plugin")," because no new scope is created and therefore we have no place to attach contextual data. In that case the plugin name will represent the boot order of all involved plugins in the format of ",(0,r.kt)("inlineCode",{parentName:"p"},"plugin-A -> plugin-B"),"."),(0,r.kt)("a",{name:"log"}),(0,r.kt)("h4",{id:"log"},"log"),(0,r.kt)("p",null,"The logger instance, check ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Logging.md"},"here"),"."),(0,r.kt)("a",{name:"inject"}),(0,r.kt)("h4",{id:"inject"},"inject"),(0,r.kt)("p",null,"Fake http injection (for testing purposes) ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Testing.md#inject"},"here"),"."),(0,r.kt)("a",{name:"add-schema"}),(0,r.kt)("h4",{id:"addschema"},"addSchema"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fastify.addSchema(schemaObj)"),", adds a shared schema to the Fastify instance. This allows you to reuse it everywhere in your application just by writing the schema id that you need.",(0,r.kt)("br",null),"\nTo learn more, see ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Validation-and-Serialization.md#shared-schema"},"shared schema example")," in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Validation-and-Serialization.md"},"Validation and Serialization")," documentation."),(0,r.kt)("a",{name:"set-reply-serializer"}),(0,r.kt)("h4",{id:"setreplyserializer"},"setReplySerializer"),(0,r.kt)("p",null,"Set the reply serializer for all the routes. This will used as default if a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Reply.md#serializerfunc"},"Reply.serializer(func)")," has not been set. The handler is fully encapsulated, so different plugins can set different error handlers.\nNote: the function parameter is called only for status ",(0,r.kt)("inlineCode",{parentName:"p"},"2xx"),". Checkout the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Server.md#seterrorhandler"},(0,r.kt)("inlineCode",{parentName:"a"},"setErrorHandler"))," for errors."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.setReplySerializer(function (payload, statusCode){\n  // serialize the payload with a sync function\n  return `my serialized ${statusCode} content: ${payload}`\n})\n\n")),(0,r.kt)("a",{name:"set-schema-compiler"}),(0,r.kt)("h4",{id:"setschemacompiler"},"setSchemaCompiler"),(0,r.kt)("p",null,"Set the schema compiler for all routes ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Validation-and-Serialization.md#schema-compiler"},"here"),"."),(0,r.kt)("a",{name:"set-schema-resolver"}),(0,r.kt)("h4",{id:"setschemaresolver"},"setSchemaResolver"),(0,r.kt)("p",null,"Set the schema ",(0,r.kt)("inlineCode",{parentName:"p"},"$ref")," resolver for all routes ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Validation-and-Serialization.md#schema-resolver"},"here"),"."),(0,r.kt)("a",{name:"schema-compiler"}),(0,r.kt)("h4",{id:"schemacompiler"},"schemaCompiler"),(0,r.kt)("p",null,"This property can be used to set the schema compiler, it is a shortcut for the ",(0,r.kt)("inlineCode",{parentName:"p"},"setSchemaCompiler")," method, and get the schema compiler back for all routes."),(0,r.kt)("a",{name:"set-not-found-handler"}),(0,r.kt)("h4",{id:"setnotfoundhandler"},"setNotFoundHandler"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fastify.setNotFoundHandler(handler(request, reply))"),": set the 404 handler. This call is encapsulated by prefix, so different plugins can set different not found handlers if a different ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Plugins.md#route-prefixing-option"},(0,r.kt)("inlineCode",{parentName:"a"},"prefix")," option")," is passed to ",(0,r.kt)("inlineCode",{parentName:"p"},"fastify.register()"),". The handler is treated like a regular route handler so requests will go through the full ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/fastify/fastify/blob/master/docs/Lifecycle.md#lifecycle"},"Fastify lifecycle"),"."),(0,r.kt)("p",null,"You can also register a ",(0,r.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Hooks/#route-hooks"},(0,r.kt)("inlineCode",{parentName:"a"},"preValidation"))," and ",(0,r.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Hooks/#route-hooks"},"preHandler")," hook for the 404 handler."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Note: The ",(0,r.kt)("inlineCode",{parentName:"em"},"preValidation")," hook registered using this method will run for a route that Fastify does not recognize and ",(0,r.kt)("strong",{parentName:"em"},"not")," when a route handler manually calls ",(0,r.kt)("a",{parentName:"em",href:"https://github.com/fastify/fastify/blob/master/docs/Reply.md#call-not-found"},(0,r.kt)("inlineCode",{parentName:"a"},"reply.callNotFound"))),". In which case only preHandler will be run."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.setNotFoundHandler({\n  preValidation: (req, reply, done) => {\n    // your code\n    done()\n  },\n  preHandler: (req, reply, done) => {\n    // your code\n    done()\n  }\n}, function (request, reply) {\n    // Default not found handler with preValidation and preHandler hooks\n})\n\nfastify.register(function (instance, options, done) {\n  instance.setNotFoundHandler(function (request, reply) {\n    // Handle not found request without preValidation and preHandler hooks\n    // to URLs that begin with '/v1'\n  })\n  done()\n}, { prefix: '/v1' })\n\n")),(0,r.kt)("a",{name:"set-error-handler"}),(0,r.kt)("h4",{id:"seterrorhandler"},"setErrorHandler"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fastify.setErrorHandler(handler(error, request, reply))"),": Set a function that will be called whenever an error happens. The handler is bound to the Fastify instance, and is fully encapsulated, so different plugins can set different error handlers. ",(0,r.kt)("em",{parentName:"p"},"async-await")," is supported as well.",(0,r.kt)("br",null),"\n",(0,r.kt)("em",{parentName:"p"},"Note: If the error ",(0,r.kt)("inlineCode",{parentName:"em"},"statusCode")," is less than 400, Fastify will automatically set it at 500 before calling the error handler.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.setErrorHandler(function (error, request, reply) {\n  // Log error\n  this.log.error(error)\n  // Send error response\n  reply.status(409).send({ ok: false })\n})\n\n")),(0,r.kt)("p",null,"Fastify is provided with a default function that is called if no error handler is set and that logs the error with respect to its ",(0,r.kt)("inlineCode",{parentName:"p"},"statusCode"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"var statusCode = error.statusCode\nif (statusCode >= 500) {\n  log.error(error)\n} else if (statusCode >= 400) {\n  log.info(error)\n} else {\n  log.error(error)\n}\n\n")),(0,r.kt)("a",{name:"print-routes"}),(0,r.kt)("h4",{id:"printroutes"},"printRoutes"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fastify.printRoutes()"),": Prints the representation of the internal radix tree used by the router, useful for debugging.",(0,r.kt)("br",null),"\n",(0,r.kt)("em",{parentName:"p"},"Remember to call it inside or after a ",(0,r.kt)("inlineCode",{parentName:"em"},"ready")," call.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"fastify.get('/test', () => {})\nfastify.get('/test/hello', () => {})\nfastify.get('/hello/world', () => {})\n\nfastify.ready(() => {\n  console.log(fastify.printRoutes())\n  // \u2514\u2500\u2500 /\n  //   \u251c\u2500\u2500 test (GET)\n  //   \u2502   \u2514\u2500\u2500 /hello (GET)\n  //   \u2514\u2500\u2500 hello/world (GET)\n})\n\n")),(0,r.kt)("a",{name:"initial-config"}),(0,r.kt)("h4",{id:"initialconfig"},"initialConfig"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"fastify.initialConfig"),": Exposes a frozen read-only object registering the initial\noptions passed down by the user to the fastify instance."),(0,r.kt)("p",null,"Currently the properties that can be exposed are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"bodyLimit"),(0,r.kt)("li",{parentName:"ul"},"caseSensitive"),(0,r.kt)("li",{parentName:"ul"},"http2"),(0,r.kt)("li",{parentName:"ul"},"https (it will return ",(0,r.kt)("inlineCode",{parentName:"li"},"false"),"/",(0,r.kt)("inlineCode",{parentName:"li"},"true")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"{ allowHTTP1: true/false }")," if explicitly passed)"),(0,r.kt)("li",{parentName:"ul"},"ignoreTrailingSlash"),(0,r.kt)("li",{parentName:"ul"},"maxParamLength"),(0,r.kt)("li",{parentName:"ul"},"onProtoPoisoning"),(0,r.kt)("li",{parentName:"ul"},"pluginTimeout"),(0,r.kt)("li",{parentName:"ul"},"requestIdHeader")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const { readFileSync } = require('fs')\nconst Fastify = require('fastify')\n\nconst fastify = Fastify({\n  https: {\n    allowHTTP1: true,\n    key: readFileSync('./fastify.key'),\n    cert: readFileSync('./fastify.cert')\n  },\n  logger: { level: 'trace'},\n  ignoreTrailingSlash: true,\n  maxParamLength: 200,\n  caseSensitive: true,\n  trustProxy: '127.0.0.1,192.168.1.1/24',\n})\n\nconsole.log(fastify.initialConfig)\n/*\nwill log :\n{\n  caseSensitive: true,\n  https: { allowHTTP1: true },\n  ignoreTrailingSlash: true,\n  maxParamLength: 200\n}\n*/\n\nfastify.register(async (instance, opts) => {\n  instance.get('/', async (request, reply) => {\n    return instance.initialConfig\n    /*\n    will return :\n    {\n      caseSensitive: true,\n      https: { allowHTTP1: true },\n      ignoreTrailingSlash: true,\n      maxParamLength: 200\n    }\n    */\n  })\n\n  instance.get('/error', async (request, reply) => {\n    // will throw an error because initialConfig is read-only\n    // and can not be modified\n    instance.initialConfig.https.allowHTTP1 = false\n\n    return instance.initialConfig\n  })\n})\n\n// Start listening.\nfastify.listen(3000, (err) => {\n  if (err) {\n    fastify.log.error(err)\n    process.exit(1)\n  }\n})\n\n")))}u.isMDXComponent=!0}}]);